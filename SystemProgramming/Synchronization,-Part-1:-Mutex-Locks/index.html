<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Synchronization, Part 1: Mutex Locks - UIUC CS241 SystemProgramming Wiki</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Synchronization, Part 1: Mutex Locks";
    var mkdocs_page_input_path = "SystemProgramming/Synchronization,-Part-1:-Mutex-Locks.md";
    var mkdocs_page_url = "/SystemProgramming/Synchronization,-Part-1:-Mutex-Locks/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> UIUC CS241 SystemProgramming Wiki</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>SystemProgramming</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../#Example Markdown/">#Example Markdown</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../#Informal-Glossary/">#Informal Glossary</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../#Piazza: When And How to Ask For Help/">#Piazza: When And How to Ask For Help</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../C-Programming,-Part-1:-Introduction/">C Programming, Part 1: Introduction</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../C-Programming,-Part-2:-Text-Input-And-Output/">C Programming, Part 2: Text Input And Output</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../C-Programming,-Part-3:-Common-Gotchas/">C Programming, Part 3: Common Gotchas</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../C-Programming,-Part-4:-Strings-and-Structs/">C Programming, Part 4: Strings and Structs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../C-Programming,-Part-5:-Debugging/">C Programming, Part 5: Debugging</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../C-Programming,-Review-Questions/">C Programming, Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../C-Programming:-Review-Questions/">C Programming: Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Deadlock,-Part-1:-Resource-Allocation-Graph/">Deadlock, Part 1: Resource Allocation Graph</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Deadlock,-Part-2:-Deadlock-Conditions/">Deadlock, Part 2: Deadlock Conditions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Deadlock,-Part-3:-Dining-Philosophers/">Deadlock, Part 3: Dining Philosophers</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Deadlock-Review-Questions/">Deadlock Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Exam-Topics/">Exam Topics</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-System,-Part-1:-Introduction/">File System, Part 1: Introduction</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-System,-Part-2:-Files-are-inodes-(everything-else-is-just-data...)/">File System, Part 2: Files are inodes (everything else is just data...)</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-System,-Part-3:-Permissions/">File System, Part 3: Permissions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-System,-Part-4:-Working-with-directories/">File System, Part 4: Working with directories</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-System,-Part-5:-Virtual-file-systems/">File System, Part 5: Virtual file systems</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-System,-Part-6:-Memory-mapped-files-and-Shared-memory/">File System, Part 6: Memory mapped files and Shared memory</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-System,-Part-7:-Scalable-and-Reliable-Filesystems/">File System, Part 7: Scalable and Reliable Filesystems</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-System,-Part-8:-Removing-preinstalled-malware-from-an-Android-device/">File System, Part 8: Removing preinstalled malware from an Android device</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-System,-Part-9:-Disk-blocks-example/">File System, Part 9: Disk blocks example</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../File-Systems-Review-Questions/">File Systems Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Files,-Part-1:-Working-with-files/">Files, Part 1: Working with files</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Filesystem:-Review-Questions/">Filesystem: Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Forking,-Part-1:-Introduction/">Forking, Part 1: Introduction</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Forking,-Part-2:-Fork,-Exec,-Wait/">Forking, Part 2: Fork, Exec, Wait</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../HW0/">HW0</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Home/">Home</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../IPC-Review-Questions/">IPC Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Memory,-Part-1:-Heap-Memory-Introduction/">Memory, Part 1: Heap Memory Introduction</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Memory,-Part-2:-Implementing-a-Memory-Allocator/">Memory, Part 2: Implementing a Memory Allocator</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Memory,-Part-3:-Smashing-the-Stack-Example/">Memory, Part 3: Smashing the Stack Example</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Memory-Review-Questions/">Memory Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Memory:-Review-Questions/">Memory: Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Multi-threaded-Programming:-Review-Questions/">Multi threaded Programming: Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking,-Part-1:-Introduction/">Networking, Part 1: Introduction</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking,-Part-2:-Using-getaddrinfo/">Networking, Part 2: Using getaddrinfo</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking,-Part-3:-Building-a-simple-TCP-Client/">Networking, Part 3: Building a simple TCP Client</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking,-Part-4:-Building-a-simple-TCP-Server/">Networking, Part 4: Building a simple TCP Server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking,-Part-5:-Shutting-down-ports,-reusing-ports-and-other-tricks/">Networking, Part 5: Shutting down ports, reusing ports and other tricks</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking,-Part-6:-Building-a-web-server/">Networking, Part 6: Building a web server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking,-Part-6:-Creating-a-UDP-server/">Networking, Part 6: Creating a UDP server</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking,-Part-7:-Nonblocking-I-O,-select(),-and-epoll/">Networking, Part 7: Nonblocking I O, select(), and epoll</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking-Review-Questions/">Networking Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Networking:-Review-Questions/">Networking: Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../OSI-Model/">OSI Model</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../POSIX,-Part-1:-Error-handling/">POSIX, Part 1: Error handling</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Pipe:-Review-Questions/">Pipe: Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Pipes,-Part-1:-Introduction-to-pipes/">Pipes, Part 1: Introduction to pipes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Pipes,-Part-2:-Pipe-programming-secrets/">Pipes, Part 2: Pipe programming secrets</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Process-Control,-Part-1:-Wait-macros,-using-signals/">Process Control, Part 1: Wait macros, using signals</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Processes,-Part-1:-Introduction/">Processes, Part 1: Introduction</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Processes-Review-Questions/">Processes Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Programming-Tricks,-Part-1/">Programming Tricks, Part 1</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Pthread-Review-Questions/">Pthread Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Pthreads,-Part-1:-Introduction/">Pthreads, Part 1: Introduction</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Pthreads,-Part-2:-Usage-in-Practice/">Pthreads, Part 2: Usage in Practice</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Pthreads,-Part-3:-Parallel-Problems-(Bonus)/">Pthreads, Part 3: Parallel Problems (Bonus)</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../RPC,-Part-1:-Introduction-to-Remote-Procedure-Calls/">RPC, Part 1: Introduction to Remote Procedure Calls</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Sample-program-using-pthread-barriers/">Sample program using pthread barriers</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Scheduling,-Part-1:-Scheduling-Processes/">Scheduling, Part 1: Scheduling Processes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Scheduling,-Part-2:-Scheduling-Processes:-Algorithms/">Scheduling, Part 2: Scheduling Processes: Algorithms</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Signals,-Part-2:-Pending-Signals-and-Signal-Masks/">Signals, Part 2: Pending Signals and Signal Masks</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Signals,-Part-3:-Raising-signals/">Signals, Part 3: Raising signals</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Signals,-Part-4:-Sigaction/">Signals, Part 4: Sigaction</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Signals-Review-Questions/">Signals Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Signals:-Review-Questions/">Signals: Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Synchronization, Part 1: Mutex Locks</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#solving-critical-sections">Solving Critical Sections</a></li>
                
                    <li><a class="toctree-l4" href="#what-is-a-critical-section">What is a Critical Section?</a></li>
                
                    <li><a class="toctree-l4" href="#is-just-incrementing-a-variable-a-critical-section">Is just incrementing a variable a critical section?</a></li>
                
                    <li><a class="toctree-l4" href="#how-do-i-ensure-only-one-thread-at-a-time-can-access-a-global-variable">How do I ensure only one thread at a time can access a global variable?</a></li>
                
                    <li><a class="toctree-l4" href="#if-i-lock-a-mutex-does-it-stop-all-other-threads">If I lock a mutex, does it stop all other threads?</a></li>
                
                    <li><a class="toctree-l4" href="#are-there-other-ways-to-create-a-mutex">Are there other ways to create a mutex?</a></li>
                
            
                <li class="toctree-l3"><a href="#mutex-gotchas">Mutex Gotchas</a></li>
                
                    <li><a class="toctree-l4" href="#so-pthread_mutex_lock-stops-the-other-threads-when-they-read-the-same-variable">So pthread_mutex_lock stops the other threads when they read the same variable?</a></li>
                
                    <li><a class="toctree-l4" href="#can-i-create-mutex-before-fork-ing">Can I create mutex before fork-ing?</a></li>
                
                    <li><a class="toctree-l4" href="#if-one-thread-locks-a-mutex-can-another-thread-unlock-it">If one thread locks a mutex can another thread unlock it?</a></li>
                
                    <li><a class="toctree-l4" href="#can-i-use-two-or-more-mutex-locks">Can I use two or more mutex locks?</a></li>
                
                    <li><a class="toctree-l4" href="#is-there-any-overhead-in-calling-lock-and-unlock">Is there any overhead in calling lock and unlock?</a></li>
                
                    <li><a class="toctree-l4" href="#simplest-complete-example">Simplest complete example?</a></li>
                
                    <li><a class="toctree-l4" href="#what-happens-if-i-forget-to-unlock">What happens if I forget to unlock?</a></li>
                
                    <li><a class="toctree-l4" href="#when-can-i-destroy-the-mutex">When can I destroy the mutex?</a></li>
                
                    <li><a class="toctree-l4" href="#can-i-copy-a-pthread_mutex_t-to-a-new-memory-locaton">Can I copy a pthread_mutex_t to a new memory locaton?</a></li>
                
                    <li><a class="toctree-l4" href="#what-would-a-simple-implementation-of-a-mutex-look-like">What would a simple implementation of a mutex look like?</a></li>
                
                    <li><a class="toctree-l4" href="#how-do-i-find-out-more">How do I find out more?</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Synchronization,-Part-2:-Counting-Semaphores/">Synchronization, Part 2: Counting Semaphores</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Synchronization,-Part-3:-Working-with-Mutexes-And-Semaphores/">Synchronization, Part 3: Working with Mutexes And Semaphores</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Synchronization,-Part-4:-The-Critical-Section-Problem/">Synchronization, Part 4: The Critical Section Problem</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Synchronization,-Part-5:-Condition-Variables/">Synchronization, Part 5: Condition Variables</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Synchronization,-Part-6:-Implementing-a-barrier/">Synchronization, Part 6: Implementing a barrier</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Synchronization,-Part-7:-The-Reader-Writer-Problem/">Synchronization, Part 7: The Reader Writer Problem</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Synchronization,-Part-8:-Ring-Buffer-Example/">Synchronization, Part 8: Ring Buffer Example</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Synchronization-Concepts:-Review-Questions/">Synchronization Concepts: Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Synchronization-Review-Questions/">Synchronization Review Questions</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../System-Programming-Jokes/">System Programming Jokes</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../System-Programming-Short-Stories-and-Songs/">System Programming Short Stories and Songs</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Test-page/">Test page</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Virtual-Memory,-Part-1:-Introduction-to-Virtual-Memory/">Virtual Memory, Part 1: Introduction to Virtual Memory</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../_Footer/"> Footer</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">UIUC CS241 SystemProgramming Wiki</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>SystemProgramming &raquo;</li>
        
      
    
    <li>Synchronization, Part 1: Mutex Locks</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="solving-critical-sections">Solving Critical Sections</h1>
<h2 id="what-is-a-critical-section">What is a Critical Section?</h2>
<p>A critical section is a section of code that can only be executed by one thread at a time, if the program is to function correctly. If two threads (or processes) were to execute code inside the critical section at the same time then it is possible that program may no longer have correct behavior.</p>
<h2 id="is-just-incrementing-a-variable-a-critical-section">Is just incrementing a variable a critical section?</h2>
<p>Possibly. Incrementing a variable (<code>i++</code>) is performed in three individual steps: Copy the memory contents to the CPU register. Increment the value in the CPU. Store the new value in memory. If the memory location is only accessible by one thread (e.g. automatic variable <code>i</code> below) then there is no possibility of a race condition and no Critical Section associated with <code>i</code>. However the <code>sum</code> variable is a global variable and accessed by two threads. It is possible that two threads may attempt to increment the variable at the same time.</p>
<pre><code class="C">#include &lt;stdio.h&gt;
#include &lt;pthread.h&gt;
// Compile with -pthread

int sum = 0; //shared

void *countgold(void *param) {
    int i; //local to each thread
    for (i = 0; i &lt; 10000000; i++) {
        sum += 1;
    }
    return NULL;
}

int main() {
    pthread_t tid1, tid2;
    pthread_create(&amp;tid1, NULL, countgold, NULL);
    pthread_create(&amp;tid2, NULL, countgold, NULL);

    //Wait for both threads to finish:
    pthread_join(tid1, NULL);
    pthread_join(tid2, NULL);

    printf(&quot;ARRRRG sum is %d\n&quot;, sum);
    return 0;
}
</code></pre>

<p>Typical output of the above code is <code>ARGGGH sum is 8140268</code>
A different sum is printed each time the program is run because there is a race condition; the code does not stop two threads from reading-writing <code>sum</code> at the same time. For example both threads copy the current value of sum into CPU that runs each thread (let's pick 123). Both threads increment one to their own copy. Both threads write back the value (124). If the threads had accessed the sum at different times then the count would have been 125.</p>
<h2 id="how-do-i-ensure-only-one-thread-at-a-time-can-access-a-global-variable">How do I ensure only one thread at a time can access a global variable?</h2>
<p>You mean, "Help - I need a mutex!"
If one thread is currently inside a critical section we would like another thread to wait until the first thread is complete. For this purpose we can use a mutex (short for Mutual Exclusion).</p>
<p>For simple examples the smallest amount of code we need to add is just three lines:</p>
<pre><code class="C">pthread_mutex_t m = PTHREAD_MUTEX_INITIALIZER; // global variable
pthread_mutex_lock(&amp;m); // start of Critical Section
pthread_mutex_unlock(&amp;m); //end of Critical Section
</code></pre>

<p>Once we are finished with the mutex we should also call <code>pthread_mutex_destroy(&amp;m)</code> too. Note, you can only destroy an unlocked mutex. Calling destroy on a destroyed lock, initializing an initialized lock, locking an already locked lock, unlocking an unlocked lock etc are unsupported (at least for default mutexes) and usually result in undefined behavior.</p>
<h2 id="if-i-lock-a-mutex-does-it-stop-all-other-threads">If I lock a mutex, does it stop all other threads?</h2>
<p>No, the other threads will continue. It's only when a thread attempts to lock a mutex that is already locked, will the thread have to wait. As soon as the original thread unlocks the mutex, the second (waiting) thread will acquire the lock and be able to continue.</p>
<h2 id="are-there-other-ways-to-create-a-mutex">Are there other ways to create a mutex?</h2>
<p>Yes. You can use the macro PTHREAD_MUTEX_INITIALIZER only for global ('static') variables.
m = PTHREAD_MUTEX_INITIALIZER is equivalent to the more general purpose
<code>pthread_mutex_init(&amp;m,NULL)</code>. The init version includes options to trade performance for additional error-checking and advanced sharing options.</p>
<pre><code class="C">pthread_mutex_t *lock = malloc(sizeof(pthread_mutex_t)); 
pthread_mutex_init(lock, NULL);
//later
pthread_mutex_destroy(lock);
free(lock);
</code></pre>

<p>Things to keep in mind about <code>init</code> and <code>destroy</code>:
<em> Multiple threads init/destroy has undefined behavior
</em> Destroying a locked mutex has undefined behavior
* Basically try to keep to the pattern of one thread initializing a mutex and one and only one thread initializing a mutex.</p>
<h1 id="mutex-gotchas">Mutex Gotchas</h1>
<h2 id="so-pthread_mutex_lock-stops-the-other-threads-when-they-read-the-same-variable"><code>So pthread_mutex_lock</code> stops the other threads when they read the same variable?</h2>
<p>No. A mutex is not that smart - it works with code (threads), not data. Only when another thread calls <code>lock</code> on a locked mutex will the second thread need to wait until the mutex is unlocked.</p>
<p>Consider</p>
<pre><code class="C">int a;
pthread_mutex_t m1 = PTHREAD_MUTEX_INITIALIZER,
                 m2 = = PTHREAD_MUTEX_INITIALIZER;
// later
// Thread 1
pthread_mutex_lock(&amp;m1);
a++;
pthread_mutex_unlock(&amp;m1);

// Thread 2
pthread_mutex_lock(&amp;m2);
a++;
pthread_mutex_unlock(&amp;m2);
</code></pre>

<p>Will still cause a race condition.</p>
<h2 id="can-i-create-mutex-before-fork-ing">Can I create mutex before fork-ing?</h2>
<p>Yes - however the child and parent process will not share virtual memory and each one will have a mutex independent of the other.</p>
<p>(Advanced note: There are advanced options using shared memory that allow a child and parent to share a mutex if it's created with the correct options and uses a shared memory segment. See <a href="http://stackoverflow.com/questions/19172541/procs-fork-and-mutexes">stackoverflow example</a> )</p>
<h2 id="if-one-thread-locks-a-mutex-can-another-thread-unlock-it">If one thread locks a mutex can another thread unlock it?</h2>
<p>No. The same thread must unlock it.</p>
<h2 id="can-i-use-two-or-more-mutex-locks">Can I use two or more mutex locks?</h2>
<p>Yes! In fact it's common to have one lock per data structure that you need to update.</p>
<p>If you only have one lock, then they may be significant contention for the lock between two threads that was unnecessary. For example if two threads were updating two different counters, it might not be necessary to use the same lock.</p>
<p>However simply creating many locks is insufficient: It's important to be able to reason about critical sections e.g. it's important that one thread can't read two data structures while they are being updated and temporarily in an inconsistent state.</p>
<h2 id="is-there-any-overhead-in-calling-lock-and-unlock">Is there any overhead in calling lock and unlock?</h2>
<p>There is a small amount of overhead of calling <code>pthread_mutex_lock</code> and <code>_unlock</code>; however this is the price you pay for correctly functioning programs!</p>
<h2 id="simplest-complete-example">Simplest complete example?</h2>
<p>A complete example is shown below</p>
<pre><code class="C">#include &lt;stdio.h&gt;
#include &lt;pthread.h&gt;

// Compile with -pthread
// Create a mutex this ready to be locked!
pthread_mutex_t m = PTHREAD_MUTEX_INITIALIZER;

int sum = 0;

void *countgold(void *param) {
    int i;

    //Same thread that locks the mutex must unlock it
    //Critical section is just 'sum += 1'
    //However locking and unlocking a million times
    //has significant overhead in this simple answer

    pthread_mutex_lock(&amp;m);

    // Other threads that call lock will have to wait until we call unlock

    for (i = 0; i &lt; 10000000; i++) {
    sum += 1;
    }
    pthread_mutex_unlock(&amp;m);
    return NULL;
}

int main() {
    pthread_t tid1, tid2;
    pthread_create(&amp;tid1, NULL, countgold, NULL);
    pthread_create(&amp;tid2, NULL, countgold, NULL);

    //Wait for both threads to finish:
    pthread_join(tid1, NULL);
    pthread_join(tid2, NULL);

    printf(&quot;ARRRRG sum is %d\n&quot;, sum);
    return 0;
}
</code></pre>

<p>In the code above, the thread gets the lock to the counting house before entering. The critical section is only the <code>sum+=1</code> so the following version is also correct but slower - </p>
<pre><code class="C">    for (i = 0; i &lt; 10000000; i++) {
        pthread_mutex_lock(&amp;m);
        sum += 1;
        pthread_mutex_unlock(&amp;m);
    }
    return NULL;
}
</code></pre>

<p>This process runs slower because we lock and unlock the mutex a million times, which is expensive - at least compared with incrementing a variable. (And in this simple example we didn't really need threads - we could have added up twice!)  A faster multi-thread example would be to add one million using an automatic(local) variable and only then adding it to a shared total after the calculation loop has finished:</p>
<pre><code class="C">    int local = 0;
    for (i = 0; i &lt; 10000000; i++) {
       local += 1;
    }

    pthread_mutex_lock(&amp;m);
    sum += local;
    pthread_mutex_unlock(&amp;m);

    return NULL;
}
</code></pre>

<h2 id="what-happens-if-i-forget-to-unlock">What happens if I forget to unlock?</h2>
<p>Deadlock! We will talk about deadlock a little bit later but what is the problem with this loop if called by multiple threads.</p>
<pre><code class="C">while(not_stop){
    //stdin may not be thread safe
    pthread_mutex_lock(&amp;m);
    char *line = getline(...);
    if(rand() % 2) { /* randomly skip lines */
         continue;
    }
    pthread_mutex_unlock(&amp;m);

    process_line(line);
}
</code></pre>

<h2 id="when-can-i-destroy-the-mutex">When can I destroy the mutex?</h2>
<p>You can only destroy an unlocked mutex</p>
<h2 id="can-i-copy-a-pthread_mutex_t-to-a-new-memory-locaton">Can I copy a pthread_mutex_t to a new memory locaton?</h2>
<p>No, copying the bytes of the mutex to a new memory location and then using the copy is <em>not</em> supported.</p>
<h2 id="what-would-a-simple-implementation-of-a-mutex-look-like">What would a simple implementation of a mutex look like?</h2>
<p>A simple (but incorrect!) suggestion is shown below. The <code>unlock</code> function simply unlocks the mutex and returns. The lock function first checks to see if the lock is already locked. If it is currently locked, it will keep checking again until another thread has unlocked the mutex.</p>
<pre><code class="C">// Version 1 (Incorrect!)

void lock(mutex_t *m) {
  while(m-&gt;locked) { /*Locked? Nevermind - just loop and check again!*/ }

  m-&gt;locked = 1;
}
void unlock(mutex_t *m) {
  m-&gt;locked = 0;
}
</code></pre>

<p>Version 1 uses 'busy-waiting' (unnecessarily wasting CPU resources) however there is a more serious problem: We have a race-condition! </p>
<p>If two threads both called <code>lock</code> concurrently it is possible that both threads would read 'm_locked' as zero. Thus both threads would believe they have exclusive access to the lock and both threads will continue. Ooops!</p>
<p>We might attempt to reduce the CPU overhead a little by calling <code>pthread_yield()</code> inside the loop  - pthread_yield suggests to the operating system that the thread does not use the CPU for a short while, so the CPU may be assigned to threads that are waiting to run. But does not fix the race-condition. We need a better implementation - can you work how to prevent the race-condition?</p>
<h2 id="how-do-i-find-out-more">How do I find out more?</h2>
<p><a href="http://cs-education.github.io/sys">Play!</a> Read the man page!
<em> <a href="http://linux.die.net/man/3/pthread_mutex_lock">pthread_mutex_lock man page</a>
</em> <a href="http://linux.die.net/man/3/pthread_mutex_unlock">pthread_mutex_unlock man page</a>
<em> <a href="http://linux.die.net/man/3/pthread_mutex_init">pthread_mutex_init man page</a>
</em> <a href="http://linux.die.net/man/3/pthread_mutex_destroy">pthread_mutex_destroy man page</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Synchronization,-Part-2:-Counting-Semaphores/" class="btn btn-neutral float-right" title="Synchronization, Part 2: Counting Semaphores">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Signals:-Review-Questions/" class="btn btn-neutral" title="Signals: Review Questions"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Signals:-Review-Questions/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Synchronization,-Part-2:-Counting-Semaphores/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
